name: JIRA Ticket Validation

on:
  pull_request:
    types: [opened, edited, reopened, synchronize]
    branches:
      - develop

jobs:
  jira-ticket-check:
    runs-on: ubuntu-latest

    steps:
      - name: Skip check if Dependabot
        if: github.actor == 'dependabot[bot]'
        run: echo "ğŸ” Dependabot PR - JIRA ì²´í¬ ìƒëµ!"

      - name: Validate JIRA ticket in PR title
        if: github.actor != 'dependabot[bot]'
        uses: actions/github-script@v7
        env:
          JIRA_EMAIL: ${{ secrets.JIRA_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
        with:
          script: |
            const prTitle = context.payload.pull_request.title;
            const match = prTitle.match(/\[(KAN-\d+)\]/);

            if (!match) {
              core.setFailed("âŒ PR ì œëª©ì— '[KAN-123]' í˜•ì‹ì˜ JIRA í‹°ì¼“ì´ í¬í•¨ë˜ì–´ì•¼ í•´ìš”.");
              return;
            }

            const ticket = match[1];
            const url = `${process.env.JIRA_BASE_URL}/rest/api/3/issue/${ticket}`;
            const auth = Buffer.from(`${process.env.JIRA_EMAIL}:${process.env.JIRA_API_TOKEN}`).toString('base64');

            const response = await fetch(url, {
              method: 'GET',
              headers: {
                'Authorization': `Basic ${auth}`,
                'Accept': 'application/json'
              }
            });

            if (response.status === 404) {
              core.setFailed(`âŒ JIRA í‹°ì¼“ '${ticket}'ì´ ì¡´ì¬í•˜ì§€ ì•Šì•„ìš”.`);
            } else if (!response.ok) {
              core.setFailed(`âŒ JIRA API í˜¸ì¶œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”. ${response.status} ${response.statusText}`);
            } else {
              console.log(`âœ… ìœ íš¨í•œ JIRA í‹°ì¼“: ${ticket}`);
            }
